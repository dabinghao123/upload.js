!function(a,b){"function"==typeof define&&define.amd?define(["jquery"],function(c){return a.Upload=b(c)}):"object"==typeof exports?module.exports=b(require("jquery")):a.Upload=b(jQuery)}(this,function($){function Upload(a,b){var c=this;if(this.fileInput=a,"INPUT"!==a.tagName||"file"!==a.type)throw Error("Upload must be applied to input of file type");if(this.container=a.parentNode,this.options=helper.extend({},{onchoose:function(){},oninvalidfile:function(a){},onsuccess:function(a){},onerror:function(a){},onbeforeupload:function(){},onafterupload:function(){},onprogress:function(a,b){},allowedFormats:[],maxSize:null,transport:"xhr",crossDomain:null,withCredentials:!1,uploadUrl:null,progressUrl:null,name:"file",autoUpload:!0,multiple:!1},b),this.options.autoUpload&&this.fileInput.addEventListener("change",function(){c.uploadFile.call(c)}),!this.options.uploadUrl)throw Error("Upload URL not specified");"function"==typeof this.options.uploadUrl&&(this.options.uploadUrl=this.options.uploadUrl()),a.setAttribute("name",this.options.name),"function"==typeof b.onchoose&&this.fileInput.addEventListener("change",b.onchoose),this.setTransport(this.options.transport),this.options.multiple&&this.transport instanceof XhrTransport?a.setAttribute("multiple","multiple"):a.removeAttribute("multiple")}var IframeTransport=function(a,b,c,d,e,f,g,h){this.fileInput=a,this.name=a.getAttribute("name"),this.uploadUrl=b,this.successCallback=f,this.errorCallback=g,this.beforeUploadCallback=d,this.afterUploadCallback=h,this.progressCallback=e,this.uuid=helper.generateUUID()};IframeTransport.prototype={setProgressUrl:function(a){this.progressUrl=a},checkProgress:function(callback){var self=this;this.progressUrl=helper.appendQueryParams(this.progressUrl,{"X-Progress-ID":this.uuid}),this.xhr=new XMLHttpRequest,this.xhr.open("GET",this.progressUrl,!0),this.xhr.onreadystatechange=function(){if(4===xhr.readyState){var response=eval(responseText);switch(response.state){case"uploading":callback.call(self,response.received,response.size),setTimeout(function(){self.xhr.send(null)},interval)}}},this.xhr.send(null)},send:function(){if(this.beforeUploadCallback.call(this)!==!1){var a=helper.appendQueryParams(this.uploadUrl,{"X-Progress-ID":this.uuid}),b=document.createElement("iframe");b.src="javascript:void(0);",b.style.display="none",b.name="iframeUpload",document.body.appendChild(b);var c=document.createElement("form");c.method="post",c.enctype="multipart/form-data",c.action=a,c.target="iframeUpload",c.style="display:none;",document.body.appendChild(c);var d=this.fileInput.cloneNode(!0),e=this.fileInput.parentNode;c.appendChild(this.fileInput),e.appendChild(d),this.fileInput=d;var f=this;b.addEventListener("load",function(){try{var a=b.contentDocument.body,d=a.textContent||a.innerText;d=d?JSON.parse(d):{},f.successCallback.call(f,d)}catch(e){f.errorCallback.call(f,e)}f.afterUploadCallback.call(f),b.parentNode.removeChild(b),c.parentNode.removeChild(c)}),c.submit(),this.progressUrl&&this.checkProgress(this.progressCallback)}}};var XhrTransport=function(a,b,c,d,e,f,g,h){this.fileInput=a,this.name=a.getAttribute("name"),this.uploadUrl=b,this.withCredentials=c,this.successCallback=f,this.errorCallback=g,this.beforeUploadCallback=d,this.afterUploadCallback=h,this.progressCallback=e};XhrTransport.prototype={createXhr:function(){var a=this,b=new XMLHttpRequest;return this.withCredentials===!0&&(b.withCredentials=!0),b.onreadystatechange=function(){if(4===b.readyState){try{if(200!==b.status)throw new Error("Server returns error code "+b.status);var c=JSON.parse(b.responseText);a.successCallback.call(a,c)}catch(d){a.errorCallback.call(a,d.message)}a.afterUploadCallback.call(a)}},"upload"in b&&(b.upload.onprogress=function(b){a.progressCallback.call(a,b.loaded,b.total)}),b},send:function(){for(var a=[],b=this.fileInput.files,c=0;c<b.length&&this.beforeUploadCallback.call(this)!==!1;c++){a[c]=this.createXhr(),a[c].open("POST",this.uploadUrl,!0),a[c].setRequestHeader("X-Requested-With","XMLHttpRequest");var d=new FormData;d.append(this.name,b[c]),a[c].send(d)}}};var helper={extend:function(){for(var a={},b=0;b<arguments.length;b++){var c=arguments[b];for(var d in c)a[d]=c[d]}return a},generateUUID:function(){for(var a="",b=0;b<32;b++)a+=Math.floor(16*Math.random()).toString(16);return a},appendQueryParams:function(a,b){var c=[],d=a.indexOf("?");d>=0&&(c=a.substr(d+1).split("&"),a=a.substr(0,d));for(var e in b)c.push(e+"="+encodeURIComponent(b[e]));return c.length>0&&(a+="?"+c.join("&")),a}};return Upload.prototype={setTransport:function(a){a&&["xhr","iframe"].indexOf(a)!==-1||(a="xhr");var b;b="xhr"===a&&"undefined"!=typeof FormData?XhrTransport:IframeTransport,this.transport=new b(this.fileInput,this.options.uploadUrl,this.options.withCredentials,this.options.onbeforeupload,this.options.onprogress,this.options.onsuccess,this.options.onerror,this.options.onafterupload),this.options.progressUrl&&"iframe"===a&&this.transport.setProgressUrl(this.options.progressUrl)},validate:function(){if(!this.options.multiple&&this.fileInput.files.length>1)throw Error("Multiple upload not allowed");for(var a=0;a<this.fileInput.files.length;a++){var b=this.fileInput.files[a];if(this.options.maxSize&&b.size>this.options.maxSize)throw Error("Size of file not allowed");if(this.options.allowedFormats.length){var c=b.name.substr(b.name.lastIndexOf(".")+1).toLowerCase();if(-1===this.options.allowedFormats.indexOf(c)&&-1===this.options.allowedFormats.indexOf(b.type))throw"Format not allowed"}}},uploadFile:function(){try{this.validate()}catch(a){return void this.options.oninvalidfile.call(this,a)}return this.transport.send(),this}},$.fn.upload=function(){var a=this,b=a.get(0);if(arguments.length&&"object"==typeof arguments[0])a.data("selfInstance",new Upload(b,arguments[0]));else{var c=a.data("selfInstance");if(!c)throw new Error("Upload not initialised");c[arguments[0]].apply(c,Array.prototype.slice.call(arguments,1))}},Upload});